<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Manufacturing Logistics Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 0;
            line-height: 1.6;
            color: #2d3748;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
            box-shadow: 0 0 0 1px rgba(0, 0, 0, 0.05);
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            text-align: center;
            position: relative;
        }
        
        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }
        
        .header h1 {
            font-size: 2.25rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            position: relative;
            z-index: 1;
        }
        
        .header p {
            font-size: 1.125rem;
            opacity: 0.9;
            position: relative;
            z-index: 1;
        }
        
        .form-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 8px;
            margin-bottom: 30px;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-group label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #2c3e50;
        }
        
        .form-group input, .form-group select {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 16px;
            transition: border-color 0.3s;
            position: relative;
            z-index: 100;
            background: white;
            cursor: pointer;
        }
        
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #3498db;
            z-index: 200;
            box-shadow: 0 0 10px rgba(52, 152, 219, 0.3);
        }
        
        .submit-btn {
            background: linear-gradient(45deg, #27ae60, #2ecc71);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
            width: 100%;
        }
        
        .submit-btn:hover {
            transform: translateY(-2px);
        }
        
        .submit-btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
        }
        
        .results-section {
            margin-top: 30px;
            display: none;
        }
        
        .results-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }
        
        .results-card {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 8px;
            border-left: 5px solid #3498db;
        }
        
        .results-card h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.2em;
        }
        
        .result-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 8px 0;
            border-bottom: 1px solid #ecf0f1;
        }
        
        .result-label {
            font-weight: 600;
            color: #7f8c8d;
        }
        
        .result-value {
            color: #2c3e50;
            font-weight: 500;
        }
        
        .agent-logs-header {
            background: linear-gradient(135deg, #1f2937 0%, #374151 100%);
            color: white;
            padding: 1rem 1.5rem;
            margin: 0;
            position: sticky;
            top: 0;
            z-index: 20;
            backdrop-filter: blur(10px);
        }
        
        .agent-logs-header h2 {
            color: white;
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .agent-logs-header p {
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.75rem;
            margin: 0;
            font-weight: 400;
        }
        
        .agent-logs-container {
            height: calc(100vh - 200px);
            overflow-y: auto;
            padding: 0;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-radius: 0;
            border: none;
            position: relative;
        }
        
        .agent-logs-container::-webkit-scrollbar {
            width: 2px;
        }
        
        .agent-logs-container::-webkit-scrollbar-track {
            background: transparent;
        }
        
        .agent-logs-container::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #3b82f6, #1d4ed8);
            border-radius: 1px;
        }
        
        .agent-logs-container::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, #2563eb, #1e40af);
        }
        
        .no-activity {
            text-align: center;
            color: #64748b;
            padding: 4rem 2rem;
            background: rgba(255, 255, 255, 0.5);
            margin: 2rem 1rem;
            border-radius: 1rem;
            backdrop-filter: blur(10px);
        }
        
        .no-activity-icon {
            font-size: 4rem;
            margin-bottom: 1.5rem;
            opacity: 0.4;
            filter: grayscale(100%);
        }
        
        .no-activity p {
            font-weight: 500;
            margin-bottom: 0.75rem;
            color: #475569;
            font-size: 1rem;
        }
        
        .no-activity small {
            font-size: 0.875rem;
            color: #94a3b8;
            font-style: italic;
        }
        
        .agent-log {
            background: rgba(255, 255, 255, 0.8);
            margin-bottom: 0.25rem;
            padding: 0.5rem 0.875rem;
            border-radius: 0;
            border: none;
            border-left: 3px solid transparent;
            box-shadow: none;
            transition: all 0.15s ease;
            animation: slideInRight 0.2s ease-out;
            backdrop-filter: blur(10px);
            position: relative;
        }
        
        .agent-log:hover {
            background: rgba(255, 255, 255, 0.95);
            border-left-color: #3b82f6;
            transform: translateX(2px);
        }
        
        .agent-log.inventory-agent {
            border-left-color: #10b981;
        }
        
        .agent-log.fleet-agent {
            border-left-color: #f59e0b;
        }
        
        .agent-log.approver-agent {
            border-left-color: #8b5cf6;
        }
        
        .agent-log.logistics-orchestrator {
            border-left-color: #ef4444;
        }
        
        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .agent-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.25rem;
        }
        
        .agent-name {
            font-weight: 500;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            opacity: 0.8;
        }
        
        .agent-name.inventory-agent {
            color: #10b981;
        }
        
        .agent-name.fleet-agent {
            color: #f59e0b;
        }
        
        .agent-name.approver-agent {
            color: #8b5cf6;
        }
        
        .agent-name.logistics-orchestrator {
            color: #ef4444;
        }
        
        .agent-timestamp {
            font-size: 0.6875rem;
            color: #94a3b8;
            font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
            opacity: 0.7;
        }
        
        .agent-message {
            color: #1f2937;
            line-height: 1.4;
            font-size: 0.8125rem;
            font-weight: 400;
        }
        
        .current-activity {
            background: linear-gradient(135deg, #1f2937 0%, #374151 100%);
            color: white;
            padding: 0.625rem 1rem;
            border-radius: 0;
            font-weight: 500;
            margin-bottom: 0.5rem;
            box-shadow: none;
            animation: none;
            font-size: 0.8125rem;
            line-height: 1.4;
            border-left: 4px solid #3b82f6;
            position: sticky;
            top: 0;
            z-index: 10;
            backdrop-filter: blur(10px);
        }
        
        .approval-section {
            margin-top: 30px;
            padding: 25px;
            background: linear-gradient(45deg, #f39c12, #e67e22);
            border-radius: 8px;
            text-align: center;
            display: none;
        }
        
        .approval-section h3 {
            color: white;
            margin-bottom: 20px;
            font-size: 1.5em;
        }
        
        .approval-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
        }
        
        .approve-btn, .reject-btn {
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .approve-btn {
            background: linear-gradient(45deg, #27ae60, #2ecc71);
            color: white;
        }
        
        .reject-btn {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            color: white;
        }
        
        .approve-btn:hover, .reject-btn:hover {
            transform: translateY(-2px);
        }
        
        .workflow-section {
            margin-top: 30px;
            display: none;
        }
        
        .progress-container {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #ecf0f1;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 15px;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #3498db, #2980b9);
            width: 0%;
            transition: width 0.5s ease;
        }
        
        .current-step {
            font-size: 18px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }
        
        .step {
            flex: 1;
            text-align: center;
            padding: 10px;
            background: #ecf0f1;
            margin: 0 5px;
            border-radius: 6px;
            font-size: 14px;
            color: #7f8c8d;
            transition: all 0.3s;
        }
        
        .step.active {
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
        }
        
        .step.completed {
            background: linear-gradient(45deg, #27ae60, #2ecc71);
            color: white;
        }
        
        .status-message {
            margin-top: 20px;
            padding: 15px;
            border-radius: 6px;
            text-align: center;
            font-weight: 600;
        }
        
        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .pulse {
            animation: pulse 2s infinite;
        }
        
        .loading {
            display: inline-block;
            margin-left: 10px;
        }
        
        .loading::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Simplified 2-Column Layout CSS */
        .main-content {
            display: flex !important;
            gap: 0;
            min-height: calc(100vh - 140px);
            width: 100%;
            overflow: hidden;
        }
        
        .sidebar {
            flex: 0 0 350px;
            background: #fafbfc;
            padding: 1.5rem;
            border-right: 1px solid #e2e8f0;
            position: relative;
        }
        
        .sidebar::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 1px;
            height: 100%;
            background: linear-gradient(180deg, transparent, #e2e8f0 20%, #e2e8f0 80%, transparent);
        }
        
        .results-area {
            flex: 1;
            background: white;
            padding: 1.5rem;
            overflow-y: auto;
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-group label {
            display: block;
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: #374151;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 1rem;
            transition: all 0.2s ease;
            font-family: inherit;
            background: white;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            transform: translateY(-1px);
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 0.875rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            width: 100%;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            position: relative;
            overflow: hidden;
        }
        
        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }
        
        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        
        .btn:hover::before {
            left: 100%;
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn:disabled {
            background: linear-gradient(135deg, #9ca3af 0%, #6b7280 100%);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .btn:disabled::before {
            display: none;
        }
        
        .hidden {
            display: none;
        }
        
        .step-progress {
            display: flex;
            justify-content: space-between;
            margin-bottom: 2rem;
            gap: 0.75rem;
            position: relative;
        }
        
        .step-progress::before {
            content: '';
            position: absolute;
            top: 2rem;
            left: 12.5%;
            right: 12.5%;
            height: 3px;
            background: linear-gradient(90deg, #e5e7eb 0%, #e5e7eb 100%);
            z-index: 1;
            border-radius: 1.5px;
            transition: all 0.5s ease;
        }
        
        .step-progress::after {
            content: '';
            position: absolute;
            top: 2rem;
            left: 12.5%;
            width: 0%;
            height: 3px;
            background: linear-gradient(90deg, #10b981 0%, #667eea 50%, #764ba2 100%);
            z-index: 2;
            border-radius: 1.5px;
            transition: width 0.8s ease;
            box-shadow: 0 0 8px rgba(16, 185, 129, 0.3);
        }
        
        .step {
            flex: 1;
            text-align: center;
            padding: 1rem 0.75rem;
            background: white;
            border-radius: 0.75rem;
            font-size: 0.875rem;
            color: #6b7280;
            transition: all 0.3s ease;
            min-width: 80px;
            border: 2px solid #e5e7eb;
            position: relative;
            z-index: 2;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
        }
        
        .step div:first-child {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
            filter: grayscale(100%);
            transition: filter 0.3s ease;
        }
        
        .step.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
            transform: scale(1.05);
            box-shadow: 0 10px 15px -3px rgba(102, 126, 234, 0.3), 0 4px 6px -2px rgba(102, 126, 234, 0.2);
        }
        
        .step.active div:first-child {
            filter: none;
            animation: bounce 2s infinite;
        }
        
        .step.completed {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border-color: #10b981;
            box-shadow: 0 4px 6px -1px rgba(16, 185, 129, 0.3);
        }
        
        .step.completed div:first-child {
            filter: none;
        }
        
        .step.waiting {
            background: #f9fafb;
            color: #6b7280;
            border-color: #e5e7eb;
        }
        
        .step.error {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            border-color: #ef4444;
            box-shadow: 0 4px 6px -1px rgba(239, 68, 68, 0.3);
        }
        
        .step.error div:first-child {
            filter: none;
            animation: shake 0.5s ease-in-out;
        }
        
        .step.warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            border-color: #f59e0b;
            box-shadow: 0 4px 6px -1px rgba(245, 158, 11, 0.3);
        }
        
        .step.warning div:first-child {
            filter: none;
            animation: pulse-warning 1s ease-in-out infinite;
        }
        
        @keyframes pulse-warning {
            0%, 100% { 
                transform: scale(1);
                opacity: 1;
            }
            50% { 
                transform: scale(1.05);
                opacity: 0.8;
            }
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        
        @keyframes bounce {
            0%, 20%, 53%, 80%, 100% {
                transform: translate3d(0,0,0);
            }
            40%, 43% {
                transform: translate3d(0, -8px, 0);
            }
            70% {
                transform: translate3d(0, -4px, 0);
            }
            90% {
                transform: translate3d(0, -2px, 0);
            }
        }
        
        /* Enhanced Step Animations for Agent Message Sync */
        @keyframes stepActivation {
            0% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(102, 126, 234, 0);
            }
            25% {
                transform: scale(1.15);
                box-shadow: 0 0 15px 3px rgba(102, 126, 234, 0.4);
            }
            50% {
                transform: scale(1.05);
                box-shadow: 0 0 25px 5px rgba(102, 126, 234, 0.6);
            }
            100% {
                transform: scale(1.05);
                box-shadow: 0 10px 15px -3px rgba(102, 126, 234, 0.3);
            }
        }
        
        @keyframes stepCompletion {
            0% {
                transform: scale(1.05);
            }
            25% {
                transform: scale(1.2) rotate(5deg);
                box-shadow: 0 0 20px 5px rgba(16, 185, 129, 0.6);
            }
            75% {
                transform: scale(1.1) rotate(-2deg);
                box-shadow: 0 0 25px 8px rgba(16, 185, 129, 0.4);
            }
            100% {
                transform: scale(1);
                box-shadow: 0 4px 6px -1px rgba(16, 185, 129, 0.3);
            }
        }
        
        @keyframes stepError {
            0%, 100% { 
                transform: translateX(0) scale(1); 
            }
            10%, 30%, 50%, 70%, 90% { 
                transform: translateX(-8px) scale(1.05); 
                box-shadow: 0 0 15px 3px rgba(239, 68, 68, 0.5);
            }
            20%, 40%, 60%, 80% { 
                transform: translateX(8px) scale(1.05); 
                box-shadow: 0 0 20px 5px rgba(239, 68, 68, 0.7);
            }
        }
        
        @keyframes stepWarning {
            0% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.08);
                box-shadow: 0 0 18px 4px rgba(245, 158, 11, 0.5);
            }
            100% {
                transform: scale(1.05);
                box-shadow: 0 4px 6px -1px rgba(245, 158, 11, 0.3);
            }
        }
        
        @keyframes activePulse {
            0%, 100% {
                transform: scale(1.05);
                opacity: 1;
            }
            50% {
                transform: scale(1.1);
                opacity: 0.9;
            }
        }
        
        @keyframes warningPulse {
            0%, 100% {
                transform: scale(1.05);
                box-shadow: 0 4px 6px -1px rgba(245, 158, 11, 0.3);
            }
            50% {
                transform: scale(1.08);
                box-shadow: 0 0 15px 3px rgba(245, 158, 11, 0.5);
            }
        }
        
        @keyframes completionPulse {
            0% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
                box-shadow: 0 0 15px 3px rgba(16, 185, 129, 0.4);
            }
            100% {
                transform: scale(1);
                box-shadow: 0 4px 6px -1px rgba(16, 185, 129, 0.3);
            }
        }
        
        /* Message Sync Indicator */
        .step.message-sync {
            animation: messageSyncFlash 0.3s ease-out !important;
        }
        
        @keyframes messageSyncFlash {
            0% {
                box-shadow: 0 0 0 0 rgba(102, 126, 234, 0);
            }
            50% {
                box-shadow: 0 0 20px 5px rgba(102, 126, 234, 0.8);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(102, 126, 234, 0);
            }
        }
        
        /* New Message Effects */
        .agent-log.new-message {
            animation: newMessageGlow 1.5s ease-out;
            border-left-width: 4px;
        }
        
        @keyframes newMessageGlow {
            0% {
                background: rgba(102, 126, 234, 0.1);
                transform: translateX(20px);
                opacity: 0;
            }
            20% {
                background: rgba(102, 126, 234, 0.15);
                transform: translateX(0);
                opacity: 1;
            }
            100% {
                background: rgba(255, 255, 255, 0.8);
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        /* Message Counter Animation */
        #messageCounter {
            transition: all 0.3s ease;
        }
        
        .message-counter-flash {
            animation: counterFlash 1.2s ease-out;
        }
        
        @keyframes counterFlash {
            0%, 100% {
                color: inherit;
            }
            50% {
                color: #10b981;
                text-shadow: 0 0 8px rgba(16, 185, 129, 0.3);
            }
        }
        
        .status-display {
            padding: 1.25rem 1.5rem;
            border-radius: 0.75rem;
            text-align: center;
            font-weight: 500;
            margin-bottom: 1.5rem;
            border-left: 4px solid;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }
        
        .status-info {
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
            color: #1e40af;
            border-left-color: #3b82f6;
        }
        
        .status-success {
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            color: #166534;
            border-left-color: #22c55e;
        }
        
        .status-warning {
            background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
            color: #92400e;
            border-left-color: #f59e0b;
        }
        
        .status-error {
            background: linear-gradient(135deg, #fef2f2 0%, #fecaca 100%);
            color: #dc2626;
            border-left-color: #ef4444;
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #ecf0f1;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 10px;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #3498db, #2980b9);
            width: 0%;
            transition: width 0.5s ease;
        }
        
        .result-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .result-card {
            background: white;
            padding: 1.5rem;
            border-radius: 0.75rem;
            border: 1px solid #e5e7eb;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            transition: all 0.2s ease;
        }
        
        .result-card:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transform: translateY(-1px);
        }
        
        .result-card h3 {
            color: #1f2937;
            margin-bottom: 1rem;
            font-size: 1.125rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .result-card p {
            margin-bottom: 0.5rem;
            color: #4b5563;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.25rem 0;
        }
        
        .result-card p strong {
            color: #1f2937;
            font-weight: 500;
        }
        
        .approval-section {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            padding: 2rem;
            border-radius: 1rem;
            text-align: center;
            margin-top: 1.5rem;
            display: block !important;
            box-shadow: 0 10px 15px -3px rgba(245, 158, 11, 0.3), 0 4px 6px -2px rgba(245, 158, 11, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .approval-section h3 {
            color: white;
            margin-bottom: 1rem;
            font-size: 1.5rem;
            font-weight: 600;
        }
        
        .approval-section p {
            color: rgba(255, 255, 255, 0.9);
            margin-bottom: 1.5rem;
            font-size: 1.125rem;
        }
        
        .approval-buttons {
            display: flex !important;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 15px;
        }
        
        .btn-approve, .btn-reject {
            padding: 0.875rem 1.5rem !important;
            border: none;
            border-radius: 0.5rem;
            font-size: 1rem !important;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 140px;
            width: auto !important;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            position: relative;
            overflow: hidden;
        }
        
        .btn-approve {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%) !important;
            color: white !important;
        }
        
        .btn-reject {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%) !important;
            color: white !important;
        }
        
        .btn-approve:hover, .btn-reject:hover {
            transform: translateY(-1px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        
        .btn-approve:active, .btn-reject:active {
            transform: translateY(0);
        }
        
        .metric-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .metric {
            text-align: center;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
        }
        
        .metric-value {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        .metric-label {
            font-size: 14px;
            color: #7f8c8d;
        }
        
        @keyframes fadeInSlide {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        #streamingMessages {
            scrollbar-width: thin;
            scrollbar-color: #cbd5e0 transparent;
        }
        
        #streamingMessages::-webkit-scrollbar {
            width: 6px;
        }
        
        #streamingMessages::-webkit-scrollbar-track {
            background: transparent;
        }
        
        #streamingMessages::-webkit-scrollbar-thumb {
            background: #cbd5e0;
            border-radius: 3px;
        }
    </style>

</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè≠ AI Manufacturing Logistics Dashboard</h1>
            <p>Manufacturing part requests with 10-second AGV dispatch and pickup delays</p>
        </div>
        
        <div class="main-content">
            <!-- Left Column: Request Form -->
            <div class="sidebar">
                <h2 style="margin-bottom: 20px;">üìã New Request</h2>
                
                <form id="requestForm">
                    <div class="form-group">
                        <label for="partNumber">Part Number</label>
                        <select id="partNumber" required>
                            <option value="">Select part number...</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="quantity">Quantity</label>
                        <input type="number" id="quantity" min="1" value="15" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="destination">Destination</label>
                        <select id="destination" required>
                            <option value="">Select destination...</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="priority">Priority</label>
                        <select id="priority">
                            <option value="">Select priority...</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="reason">Reason for Request</label>
                        <textarea id="reason" rows="3">Regular production maintenance replacement</textarea>
                    </div>
                    
                    <button type="submit" class="btn" id="submitBtn">üöÄ Submit Request</button>
                </form>
            </div>
            
            <!-- Right Column: Results Area -->
            <div class="results-area">
                <div id="welcomeSection">
                    <h2>üéØ Welcome to AI Manufacturing Logistics</h2>
                    <p style="margin: 15px 0;">üëà <strong>Use the form</strong> to create a new manufacturing part request.</p>
                </div>
                
                <div id="workflowSection" class="hidden">
                    <div id="statusDisplay" class="status-display status-info">
                        Processing request...
                    </div>
                    
                    <!-- Approval Panel (hidden by default) -->
                    <div id="approvalPanel" style="display: none; margin: 20px 0; padding: 20px; border: 2px solid #f59e0b; border-radius: 8px; background: #fef3c7;">
                        <h3 style="color: #92400e; margin: 0 0 15px 0;">‚öñÔ∏è Manual Approval Required</h3>
                        <div id="approvalDetails" style="margin-bottom: 15px; font-weight: bold; color: #92400e;"></div>
                        <div style="margin-bottom: 15px;">
                            <label for="approvalReason" style="display: block; margin-bottom: 5px; font-weight: bold;">Reason (optional):</label>
                            <input type="text" id="approvalReason" placeholder="Enter approval/rejection reason..." style="width: 100%; padding: 8px; border: 1px solid #d97706; border-radius: 4px;">
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button id="approveBtn" onclick="handleApproval('approve')" style="
                                padding: 10px 20px;
                                background: #10b981;
                                color: white;
                                border: none;
                                border-radius: 6px;
                                cursor: pointer;
                                font-weight: bold;
                            ">‚úÖ Approve Request</button>
                            <button id="rejectBtn" onclick="handleApproval('reject')" style="
                                padding: 10px 20px;
                                background: #ef4444;
                                color: white;
                                border: none;
                                border-radius: 6px;
                                cursor: pointer;
                                font-weight: bold;
                            ">‚ùå Reject Request</button>
                        </div>
                    </div>
                    
                    <!-- LLM Response Area -->
                    <div id="llmResponseArea" style="margin: 20px 0;">
                        <h3>ü§ñ AI Analysis & Recommendations 
                            <button onclick="testLLMDisplay()" style="font-size: 12px; margin-left: 10px; padding: 4px 8px;">Test</button>
                        </h3>
                        <div id="llmResponse" style="
                            width: 100%;
                            min-height: 200px;
                            padding: 20px;
                            border: 2px solid #3b82f6;
                            border-radius: 8px;
                            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
                            font-size: 14px;
                            line-height: 1.6;
                            background: #f0f9ff;
                            color: #1e40af;
                            white-space: pre-wrap;
                        ">Waiting for AI analysis...</div>
                    </div>

                    <!-- Action Log Area -->
                    <div id="actionLogArea" style="margin: 20px 0;">
                        <h3>‚öôÔ∏è Agent Actions</h3>
                        <textarea id="streamingMessages" readonly style="
                            width: 100%;
                            height: 250px;
                            padding: 15px;
                            border: 2px solid #e0e0e0;
                            border-radius: 8px;
                            font-family: 'Courier New', monospace;
                            font-size: 12px;
                            background: #f8f9fa;
                            color: #333;
                            resize: vertical;
                            white-space: pre-wrap;
                        " placeholder="Waiting for agent activity..."></textarea>
                    </div>
                    
                    <div id="analysisResults" class="hidden">
                        <h3>üìã Analysis Results</h3>
                        <div class="result-grid">
                            <div class="result-card">
                                <h3>üì¶ Inventory Agent Response</h3>
                                <div id="inventoryResponse"></div>
                            </div>
                            <div class="result-card">
                                <h3>ÔøΩ Fleet Agent Response</h3>
                                <div id="fleetResponse"></div>
                            </div>
                            <div class="result-card">
                                <h3>‚öñÔ∏è Approval Agent Response</h3>
                                <div id="approvalResponse"></div>
                            </div>
                            <div class="result-card">
                                <h3>ü§ñ Orchestrator Summary</h3>
                                <div id="orchestratorResponse"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="approvalSection" class="hidden">
                        <div class="approval-section">
                            <h3>‚öñÔ∏è High Cost - Supervisor Approval Required</h3>
                            <p id="approvalSummary">This request requires supervisor approval due to high cost.</p>
                            <div class="approval-buttons">
                                <button class="btn btn-approve" id="approveBtn">‚úÖ Approve Request</button>
                                <button class="btn btn-reject" id="rejectBtn">‚ùå Reject Request</button>
                            </div>
                        </div>
                    </div>
                    
                    <div id="completionSection" class="hidden">
                        <div class="result-card" style="margin-top: 1.5rem; border: 2px solid #10b981; background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);">
                            <h3>üéâ Request Processed Successfully!</h3>
                            <div id="finalSummary">
                                <!-- Final summary will be shown here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>

        // Global variables for streaming
        let eventSource = null;
        let streamingMessages = [];
        
        document.getElementById('requestForm').addEventListener('submit', function(e) {
            e.preventDefault();
            submitRequest();
        });
        
        document.getElementById('approveBtn').addEventListener('click', function() {
            approveRequest();
        });
        
        document.getElementById('rejectBtn').addEventListener('click', function() {
            rejectRequest();
        });
        
        function submitRequest() {
            // Clear previous results first
            clearPreviousResults();
            
            const formData = {
                part_number: document.getElementById('partNumber').value,
                quantity_requested: parseInt(document.getElementById('quantity').value),
                destination: document.getElementById('destination').value,
                priority: document.getElementById('priority').value,
                urgency_reason: document.getElementById('reason').value,
                timestamp: new Date().toISOString()
            };
            
            // Show workflow section
            document.getElementById('welcomeSection').classList.add('hidden');
            document.getElementById('workflowSection').classList.remove('hidden');
            document.getElementById('submitBtn').disabled = true;
            
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.textContent = '‚è≥ Processing...';
            
            workflowStartTime = Date.now();
            
            // Start streaming
            startStreaming();
            
            // Update status
            updateStatus('üöÄ Starting AI analysis...', 'info');
            
            fetch('/api/submit_request', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            })
            .then(response => response.json())
            .then(data => {
                if (!data.success) {
                    updateStatus('Error: ' + data.error, 'error');
                    stopStreaming();
                }
            })
            .catch(error => {
                updateStatus('Network error: ' + error, 'error');
                stopStreaming();
            });
        }
        
        function startStreaming() {
            // Close existing stream
            if (eventSource) {
                eventSource.close();
            }
            
            // Clear and initialize both areas
            const actionLog = document.getElementById('streamingMessages');
            if (actionLog) {
                actionLog.value = `=== Agent Activity Log Started at ${new Date().toLocaleTimeString()} ===\n`;
            }
            
            const llmArea = document.getElementById('llmResponse');
            if (llmArea) {
                llmArea.innerHTML = 'ü§ñ Waiting for AI analysis...';
            }
            
            // Start new EventSource for streaming
            eventSource = new EventSource('/api/stream');
            
            eventSource.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    console.log('üì• Received message:', data); // Debug
                    
                    if (data.type === 'status') {
                        // Final status received
                        console.log('üèÅ Final status received:', data.status);
                        handleFinalResults(data);
                        stopStreaming();
                    } else if (data.type === 'connection') {
                        console.log('üîó [Orchestrator] Stream connected:', data.content);
                        updateStatus('üîÑ Agent orchestrator started...', 'info');
                        displayStreamingMessage({
                            agent: 'Orchestrator',
                            message: data.content,
                            message_type: 'system',
                            timestamp: data.timestamp
                        });
                    } else if (data.type === 'agent_event') {
                        // Main agent events - like async for event in stream
                        console.log('ÔøΩ Agent event received:', data);
                        displayStreamingMessage({
                            agent: data.agent,
                            message: data.content,
                            message_type: data.message_type,
                            timestamp: data.timestamp
                        });
                    } else if (data.type === 'completion') {
                        console.log('‚úÖ [Orchestrator] Task complete:', data);
                        updateStatus('‚úÖ Analysis complete!', 'success');
                        displayStreamingMessage({
                            agent: 'Orchestrator',
                            message: data.content,
                            message_type: 'completion',
                            timestamp: data.timestamp
                        });
                        if (data.results) {
                            displayResults(data.results);
                        }
                        
                        // Reset the submit button
                        const submitButton = document.querySelector('button[type="submit"]');
                        if (submitButton) {
                            submitButton.textContent = 'Submit Request';
                            submitButton.disabled = false;
                        }
                        
                        stopStreaming();
                    } else if (data.type === 'heartbeat') {
                        console.log('üíì Heartbeat:', data.content || 'Connection active');
                    } else if (data.type === 'error') {
                        console.error('‚ùå Stream error:', data.content);
                        updateStatus('‚ùå Stream error: ' + data.content, 'error');
                        displayStreamingMessage({
                            agent: 'System',
                            message: data.content,
                            message_type: 'error',
                            timestamp: data.timestamp
                        });
                        stopStreaming();
                    } else {
                        // Fallback for any other message format
                        console.log('üîÑ Processing message:', data);
                        displayStreamingMessage(data);
                    }
                } catch (e) {
                    console.error('Error parsing streaming data:', e, 'Raw data:', event.data);
                }
            };
            
            eventSource.onopen = function(event) {
                console.log('‚úÖ Streaming connection established');
                updateStatus('üîÑ Connected to agent processing stream...', 'info');
            };
            
            eventSource.onerror = function(event) {
                console.error('‚ùå Streaming connection error:', event);
                
                if (eventSource.readyState === EventSource.CONNECTING) {
                    console.log('üîÑ Attempting to reconnect...');
                    updateStatus('üîÑ Reconnecting to agent stream...', 'warning');
                } else if (eventSource.readyState === EventSource.CLOSED) {
                    console.log('‚ùå Stream connection closed');
                    updateStatus('‚ùå Connection lost - please refresh page', 'error');
                    stopStreaming();
                } else {
                    updateStatus('‚ö†Ô∏è Connection issue - retrying...', 'warning');
                }
            };
        }
        
        function stopStreaming() {
            if (eventSource) {
                eventSource.close();
                eventSource = null;
            }
        }
        
        function displayStreamingMessage(message) {
            console.log('üéØ displayStreamingMessage called with:', message);
            
            // Add message to streaming display area
            addStreamingMessageToDisplay(message);
            
            // ALSO add to the simple text area for debugging
            addToTextArea(message);
            
            // Update status based on message
            updateStatusFromMessage(message);
        }
        
        function addToTextArea(message) {
            const timestamp = new Date().toLocaleTimeString();
            const agent = message.agent || 'System';
            const content = message.message || message.content || 'No message';
            const type = message.message_type || 'info';
            
            // Check if this is a final LLM response/summary - be VERY inclusive
            const isLLMResponse = (
                // Completion messages from Orchestrator
                (type === 'completion' && agent === 'Orchestrator') ||
                // Any long content from Orchestrator 
                (agent === 'Orchestrator' && content.length > 150) ||
                // Content with analysis keywords
                (content.includes('analysis') || content.includes('recommendation') || content.includes('function calls')) ||
                // Content with tool planning
                (content.includes('inventory_agent_tool') || content.includes('fleet_agent_tool') || content.includes('approval_agent_tool')) ||
                // Content that looks like structured responses
                (content.includes('{"name":') && content.includes('parameters')) ||
                // Any multi-line orchestrator response
                (agent === 'Orchestrator' && content.includes('\n') && content.length > 50)
            );
            
            console.log('üîç LLM Response Check:', {agent, type, contentLength: content.length, isLLMResponse, preview: content.substring(0, 100)});
            
            if (isLLMResponse) {
                // This is the main LLM response - put it in the response area
                const llmArea = document.getElementById('llmResponse');
                if (llmArea) {
                    // Format the content nicely
                    let formattedContent = content;
                    
                    // Clean up JSON formatting for better readability
                    if (content.includes('```json')) {
                        formattedContent = content.replace(/```json/g, '\n--- Tool Call ---\n');
                        formattedContent = formattedContent.replace(/```/g, '\n--- End Tool Call ---\n');
                    }
                    
                    llmArea.innerHTML = `<strong>ü§ñ AI Analysis & Recommendations:</strong><br><br>${formattedContent}`;
                    llmArea.style.border = '2px solid #10b981'; // Green border when populated
                }
            }
            
            // Always add to action log (except long completion messages)
            const actionLog = document.getElementById('streamingMessages');
            if (actionLog) {
                let logLine;
                if (type === 'completion' && content.length > 100) {
                    logLine = `[${timestamp}] ${agent}: ‚úÖ Analysis complete - see results above\n`;
                } else {
                    logLine = `[${timestamp}] ${agent}: ${content}\n`;
                }
                
                actionLog.value += logLine;
                actionLog.scrollTop = actionLog.scrollHeight;
            }
        }
        
        function addStreamingMessageToDisplay(message) {
            // Create or get streaming messages container
            let streamingContainer = document.getElementById('streamingMessages');
            if (!streamingContainer) {
                streamingContainer = document.createElement('div');
                streamingContainer.id = 'streamingMessages';
                streamingContainer.innerHTML = '<h3>üîÑ Live Agent Processing</h3>';
                streamingContainer.style.cssText = `
                    background: #f8fafc;
                    padding: 1rem;
                    border-radius: 0.5rem;
                    margin-bottom: 1rem;
                    border-left: 4px solid #3b82f6;
                    max-height: 400px;
                    overflow-y: auto;
                `;
                
                // Insert before results
                const resultsArea = document.querySelector('.results-area');
                const statusDisplay = document.getElementById('statusDisplay');
                resultsArea.insertBefore(streamingContainer, statusDisplay.nextSibling);
            }
            
            // Get message type styling
            const messageStyle = getMessageTypeStyle(message.message_type || 'info');
            
            // Create message element
            const messageEl = document.createElement('div');
            messageEl.style.cssText = `
                padding: 0.5rem 0.75rem;
                margin: 0.25rem 0;
                background: ${messageStyle.background};
                border-radius: 0.375rem;
                border-left: 4px solid ${messageStyle.borderColor};
                animation: fadeInSlide 0.3s ease-out;
                ${messageStyle.extra || ''}
            `;
            
            const icon = getMessageIcon(message.message_type || 'info');
            
            messageEl.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.25rem;">
                    <strong style="color: ${getAgentColor(message.agent)}; font-size: 0.875rem;">
                        ${icon} ${message.agent}
                    </strong>
                    <span style="font-size: 0.75rem; color: #6b7280;">${new Date(message.timestamp).toLocaleTimeString()}</span>
                </div>
                <div style="color: #374151; font-size: 0.875rem; ${messageStyle.textStyle || ''}">${message.message}</div>
            `;
            
            streamingContainer.appendChild(messageEl);
            
            // Auto-scroll to bottom
            streamingContainer.scrollTop = streamingContainer.scrollHeight;
        }
        
        function getMessageTypeStyle(messageType) {
            const styles = {
                'tool': {
                    background: '#fef3c7',
                    borderColor: '#f59e0b',
                    textStyle: 'font-weight: 600;'
                },
                'llm_response': {
                    background: '#dbeafe',
                    borderColor: '#3b82f6',
                    textStyle: 'font-style: italic;'
                },
                'network': {
                    background: '#f3f4f6',
                    borderColor: '#6b7280',
                    textStyle: 'font-family: monospace; font-size: 0.8rem;'
                },
                'system': {
                    background: '#e0e7ff',
                    borderColor: '#6366f1',
                    textStyle: 'font-weight: 500;'
                },
                'completion': {
                    background: '#dcfce7',
                    borderColor: '#22c55e',
                    textStyle: 'font-weight: 600;'
                },
                'error': {
                    background: '#fee2e2',
                    borderColor: '#ef4444',
                    textStyle: 'font-weight: 500; color: #dc2626;'
                },
                'data': {
                    background: '#f0f9ff',
                    borderColor: '#0ea5e9',
                    textStyle: 'font-family: monospace; font-size: 0.85rem;'
                },
                'detail': {
                    background: '#ecfdf5',
                    borderColor: '#10b981',
                    textStyle: ''
                },
                'info': {
                    background: 'white',
                    borderColor: '#e5e7eb',
                    textStyle: ''
                }
            };
            return styles[messageType] || styles['info'];
        }
        
        function getMessageIcon(messageType) {
            const icons = {
                'tool': 'üîß',
                'llm_response': 'ü§ñ',
                'network': 'üåê',
                'system': '‚öôÔ∏è',
                'completion': '‚úÖ',
                'error': '‚ùå',
                'data': 'üìä',
                'detail': 'üìã',
                'info': 'üí¨'
            };
            return icons[messageType] || 'üí¨';
        }
        
        function getAgentColor(agent) {
            const colors = {
                'System': '#6b7280',
                'Orchestrator': '#ef4444',
                'Inventory Agent': '#10b981',
                'Fleet Agent': '#f59e0b',
                'Approval Agent': '#8b5cf6'
            };
            return colors[agent] || '#3b82f6';
        }
        
        function updateStatusFromMessage(message) {
            const statusMessages = {
                'System': {
                    'Starting logistics analysis...': 'Initializing AI agents...',
                    'Initializing AI agents...': 'Setting up analysis environment...',
                    'All processing completed': 'Analysis completed successfully!'
                },
                'Orchestrator': {
                    'Processing request': 'AI orchestrator analyzing request...',
                    'Running comprehensive analysis...': 'Deep analysis in progress...',
                    'Analysis completed successfully': 'Orchestrator analysis complete'
                },
                'Inventory Agent': {
                    'Checking inventory availability...': 'üì¶ Checking inventory levels...'
                },
                'Fleet Agent': {
                    'Analyzing delivery capacity...': 'üöõ Analyzing fleet availability...'
                },
                'Approval Agent': {
                    'High-value request detected': '‚öñÔ∏è High-cost approval required...'
                }
            };
            
            const agentMessages = statusMessages[message.agent];
            if (agentMessages) {
                for (const [key, status] of Object.entries(agentMessages)) {
                    if (message.message.includes(key)) {
                        updateStatus(status, 'info');
                        break;
                    }
                }
            }
        }
        
        function handleFinalResults(data) {
            // Hide streaming container
            const streamingContainer = document.getElementById('streamingMessages');
            if (streamingContainer) {
                streamingContainer.style.transition = 'opacity 0.5s ease';
                streamingContainer.style.opacity = '0.5';
            }
            
            if (data.results) {
                displayAnalysisResults(data.results);
            }
            
            updateStatus('‚úÖ Analysis completed!', 'success');
        }
        
        function clearPreviousResults() {
            // Clear previous streaming messages
            const streamingContainer = document.getElementById('streamingMessages');
            if (streamingContainer) {
                streamingContainer.remove();
            }
            
            // Hide results sections
            document.getElementById('analysisResults').classList.add('hidden');
            document.getElementById('approvalSection').classList.add('hidden');
            document.getElementById('completionSection').classList.add('hidden');
            
            // Clear message arrays
            streamingMessages = [];
        }
        
        function approveRequest() {
            updateStatus('‚úÖ Request approved and processed!', 'success');
            
            // Hide approval section
            document.getElementById('approvalSection').classList.add('hidden');
            
            // Show completion
            const results = window.lastResults || {};
            const cost = window.lastCost || 0;
            showCompletionWithSummary(results, cost);
        }
        
        function rejectRequest() {
            updateStatus('‚ùå Request rejected by supervisor', 'error');
            
            // Hide approval section
            document.getElementById('approvalSection').classList.add('hidden');
            
            // Enable form for new request
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = false;
            submitBtn.textContent = 'üöÄ Submit New Request';
        }
        

        
        function handleRealtimeEvent(eventData) {
            
            switch(eventData.type) {
                case 'connected':
                    break;
                    
                case 'workflow_update':
                    updateWorkflowFromEvent(eventData);
                    break;
                    
                case 'agent_message':
                    displayNewAgentMessage(eventData.log);
                    syncStepWithAgentMessage(eventData.log);
                    break;
                    
                case 'workflow_complete':
                    handleWorkflowCompletion();
                    stopRealTimeUpdates();
                    break;
                    
                case 'error':
                    break;
                    
                default:
            }
        }
        
        function updateWorkflowFromEvent(eventData) {
            // Create a status object from the event data
            const status = {
                status: eventData.status,
                step: eventData.step,
                phase: eventData.phase,
                agent_activity: eventData.agent_activity
            };

            // Expose latest workflow info for debugging & synchronization checks
            try {
                window.latestWorkflowStatus = status.status;
                window.latestWorkflowStep = typeof status.step === 'number' ? status.step : (window.latestWorkflowStep || 0);
            } catch (e) {
                // ignore in restricted environments
            }
            
            // Update step progress
            updateStepProgress(status);
            
            // Update agent activity
            if (status.agent_activity) {
                updateAgentActivity(status.agent_activity);
            }
            
            // Update status message based on current state
            switch(status.status) {
                case 'analyzing':
                    updateStatus('ü§ñ AI agents analyzing request...', 'info');
                    break;
                case 'awaiting_approval':
                    updateStatus('‚úÖ Analysis complete. Awaiting supervisor approval.', 'warning');
                    break;
                case 'agv_dispatch_phase1':
                    updateStatus('üöÄ AGV Dispatch - Phase 1: Preparing AGV for dispatch...', 'info');
                    updateProgress('AGV Dispatch - Phase 1', 10);
                    break;
                case 'agv_dispatch_phase2':
                    updateStatus('ü§ñ AGV Dispatch - Phase 2: AGV navigating to pickup point...', 'info');
                    updateProgress('AGV Dispatch - Phase 2', 30);
                    break;
                case 'material_pickup_phase1':
                    updateStatus('üì¶ Material Pickup - Phase 1: Loading materials...', 'info');
                    updateProgress('Material Pickup - Phase 1', 50);
                    break;
                case 'material_pickup_phase2':
                    updateStatus('‚úÖ Material Pickup - Phase 2: Securing materials...', 'info');
                    updateProgress('Material Pickup - Phase 2', 80);
                    break;
                case 'delivery':
                    updateStatus('üéØ Final Delivery: AGV delivering to destination...', 'info');
                    updateProgress('Delivery in Progress', 95);
                    break;
                case 'completed':
                    updateStatus('‚úÖ Workflow completed successfully!', 'success');
                    // Don't automatically stop here, let the workflow_complete event handle it
                    break;
                case 'error':
                    updateStatus('‚ùå Workflow error occurred', 'error');
                    stopRealTimeUpdates();
                    break;
            }
        }
        
        function displayNewAgentMessage(logEntry) {
            // Display a single new agent message immediately
            
            if (!logEntry) {
                return;
            }
            
            // Debug: show incoming log step vs latest workflow step
            try {
                console.log('üìä Agent message:', {
                    agent: logEntry.agent, 
                    step: logEntry.step, 
                    message: logEntry.message, 
                    timestamp: logEntry.timestamp,
                    latestWorkflowStep: window.latestWorkflowStep
                });
            } catch (e) {
                // Ignore debug errors
            }
            
            const agentLogsContainer = document.getElementById('agentLogs');
            
            // Hide "no activity" message when we have logs
            const noActivity = agentLogsContainer.querySelector('.no-activity');
            if (noActivity) {
                noActivity.remove();
            }
            
            const logDiv = document.createElement('div');
            
            // Add agent-specific CSS classes
            const agentClass = logEntry.agent.toLowerCase().replace(/\s+/g, '-');
            logDiv.className = `agent-log ${agentClass} new-message`;
            
            logDiv.innerHTML = `
                <div class="agent-header">
                    <span class="agent-name ${agentClass}">${logEntry.agent}</span>
                    <span class="agent-timestamp">${logEntry.timestamp}</span>
                </div>
                <div class="agent-message">${logEntry.message}</div>
            `;
            
            // Add smooth entrance animation with glow effect
            logDiv.style.opacity = '0';
            logDiv.style.transform = 'translateX(20px)';
            agentLogsContainer.appendChild(logDiv);
            
            // Add new message indicator flash
            showNewMessageIndicator(logEntry.agent);
            
            // Trigger animation
            setTimeout(() => {
                logDiv.style.transition = 'all 0.3s ease-out';
                logDiv.style.opacity = '1';
                logDiv.style.transform = 'translateX(0)';
                
                // Add new message glow
                logDiv.style.boxShadow = '0 0 15px rgba(102, 126, 234, 0.4)';
                setTimeout(() => {
                    logDiv.style.boxShadow = '';
                    logDiv.classList.remove('new-message');
                }, 1500);
            }, 10);
            
            // Update message counter
            totalMessageCount++;
            updateMessageCounter();
            
            // Smooth auto-scroll to bottom
            setTimeout(() => {
                agentLogsContainer.scrollTo({
                    top: agentLogsContainer.scrollHeight,
                    behavior: 'smooth'
                });
            }, 100);
        }
        
        function showNewMessageIndicator(agentName) {
            // Show a brief flash indicator for new messages
            const messageCounter = document.getElementById('messageCounter');
            const originalText = messageCounter.textContent;
            
            messageCounter.style.color = '#10b981';
            messageCounter.style.fontWeight = '600';
            messageCounter.textContent = `üì® New from ${agentName}`;
            
            setTimeout(() => {
                messageCounter.style.color = '';
                messageCounter.style.fontWeight = '';
                updateMessageCounter();
            }, 1200);
        }
        
        function syncStepWithAgentMessage(logEntry) {
            // Synchronize step progress indicators with agent messages
            if (!logEntry || !logEntry.step) return;
            
            const stepNum = logEntry.step;
            const agent = logEntry.agent.toLowerCase();
            
            // Step mapping based on workflow phases and agent activities
            let targetStep = stepNum;
            
            // Map agent messages to appropriate workflow steps
            if (agent.includes('inventory') || logEntry.message.toLowerCase().includes('inventory')) {
                targetStep = 2; // Inventory step
            } else if (agent.includes('fleet') || logEntry.message.toLowerCase().includes('fleet')) {
                targetStep = 3; // Fleet step  
            } else if (agent.includes('approver') || logEntry.message.toLowerCase().includes('approval')) {
                targetStep = 4; // Cost/Approval step
            } else if (agent.includes('agv') || logEntry.message.toLowerCase().includes('agv')) {
                // AGV messages map to steps 5-7 based on content
                if (logEntry.message.toLowerCase().includes('dispatch') || logEntry.message.toLowerCase().includes('accepting')) {
                    targetStep = 5; // AGV Dispatch
                } else if (logEntry.message.toLowerCase().includes('pickup') || logEntry.message.toLowerCase().includes('loading')) {
                    targetStep = 6; // Pickup
                } else if (logEntry.message.toLowerCase().includes('delivery') || logEntry.message.toLowerCase().includes('completed')) {
                    targetStep = 7; // Delivery
                }
            } else if (agent.includes('orchestrator') || agent.includes('logistics')) {
                targetStep = 1; // Analysis step
            }
            
            // Animate and update the corresponding step
            animateStepProgress(targetStep, logEntry);
            
            // Mark previous steps as completed with delay for visual flow
            setTimeout(() => {
                for (let i = 1; i < targetStep; i++) {
                    const prevStep = document.getElementById('step' + i);
                    if (prevStep && !prevStep.classList.contains('completed')) {
                        prevStep.className = 'step completed';
                        // Add completion pulse animation
                        prevStep.style.animation = 'completionPulse 0.6s ease-out';
                        setTimeout(() => {
                            prevStep.style.animation = '';
                        }, 600);
                    }
                }
            }, 200);
        }
        
        function animateStepProgress(stepNumber, logEntry) {
            const stepElement = document.getElementById('step' + stepNumber);
            if (!stepElement) return;
            
            // Determine step state based on message content and agent
            let stepState = 'active';
            const message = logEntry.message.toLowerCase();
            const agent = logEntry.agent.toLowerCase();
            
            // Check for completion indicators
            if (message.includes('completed') || message.includes('success') || message.includes('‚úÖ')) {
                stepState = 'completed';
            }
            // Check for error indicators  
            else if (message.includes('error') || message.includes('failed') || message.includes('‚ùå')) {
                stepState = 'error';
            }
            // Check for warning indicators
            else if (message.includes('warning') || message.includes('partial') || message.includes('‚ö†Ô∏è')) {
                stepState = 'warning';
            }
            
            // Apply the state with animation
            stepElement.className = `step ${stepState}`;
            
            // Add message-triggered animation based on state
            switch(stepState) {
                case 'active':
                    stepElement.style.animation = 'stepActivation 0.8s ease-out';
                    // Add pulsing for active steps
                    setTimeout(() => {
                        if (stepElement.classList.contains('active')) {
                            stepElement.style.animation = 'activePulse 2s ease-in-out infinite';
                        }
                    }, 800);
                    break;
                    
                case 'completed':
                    stepElement.style.animation = 'stepCompletion 0.6s ease-out';
                    setTimeout(() => {
                        stepElement.style.animation = '';
                    }, 600);
                    break;
                    
                case 'error':
                    stepElement.style.animation = 'stepError 0.5s ease-in-out';
                    setTimeout(() => {
                        stepElement.style.animation = '';
                    }, 500);
                    break;
                    
                case 'warning':
                    stepElement.style.animation = 'stepWarning 1s ease-in-out';
                    setTimeout(() => {
                        if (stepElement.classList.contains('warning')) {
                            stepElement.style.animation = 'warningPulse 1.5s ease-in-out infinite';
                        }
                    }, 1000);
                    break;
            }
            
            // Add a subtle border flash to indicate message sync
            stepElement.style.boxShadow = '0 0 20px rgba(102, 126, 234, 0.6)';
            setTimeout(() => {
                stepElement.style.boxShadow = '';
            }, 300);
            
            // Update progress line
            updateProgressLine();
            
            console.log(`üéØ Step ${stepNumber} synced with ${logEntry.agent}: ${stepState}`);
        }
        
        function updateProgressLine() {
            // Calculate progress based on completed and active steps
            let completedSteps = 0;
            let activeStep = 0;
            
            for (let i = 1; i <= 7; i++) {
                const step = document.getElementById('step' + i);
                if (step.classList.contains('completed')) {
                    completedSteps = i;
                } else if (step.classList.contains('active') && activeStep === 0) {
                    activeStep = i;
                    break;
                }
            }
            
            // Calculate progress percentage
            let progressPercent = 0;
            if (completedSteps > 0) {
                progressPercent = (completedSteps / 7) * 75; // 75% for completed steps
            } else if (activeStep > 0) {
                progressPercent = ((activeStep - 1) / 7) * 75 + 10; // Partial progress for active step
            }
            
            // Update the progress line
            const stepProgress = document.querySelector('.step-progress');
            if (stepProgress) {
                stepProgress.style.setProperty('--progress-width', `${progressPercent}%`);
                
                // Add CSS custom property for the progress line
                const style = document.createElement('style');
                style.textContent = `
                    .step-progress::after {
                        width: ${progressPercent}% !important;
                    }
                `;
                
                // Remove previous progress styles and add new one
                const existingProgressStyle = document.querySelector('#progress-style');
                if (existingProgressStyle) {
                    existingProgressStyle.remove();
                }
                style.id = 'progress-style';
                document.head.appendChild(style);
            }
        }
        
        function handleWorkflowCompletion() {
            // Stop all animations and show completed state
            updateStatus('‚úÖ Workflow completed successfully!', 'success');
            
            // Mark all steps as completed
            for (let i = 1; i <= 7; i++) {
                document.getElementById('step' + i).className = 'step completed';
            }
            
            // Show completion section
            const completionSection = document.getElementById('completionSection');
            if (completionSection) {
                completionSection.classList.remove('hidden');
            }
            
            // Update current activity to show completion
            updateAgentActivity('‚úÖ All operations completed successfully - Ready for new request');
            
            // Enable submit button for new requests
            const submitBtn = document.getElementById('submitBtn');
            if (submitBtn) {
                submitBtn.disabled = false;
                submitBtn.textContent = 'üöÄ Start New Workflow';
                submitBtn.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
            }
            
            console.log('üéØ Workflow completion UI update complete');
        }
        
        function updateWorkflowDisplay(status) {
            // Update step progress
            updateStepProgress(status);
            
            // Update agent activity if available
            if (status.agent_activity) {
                updateAgentActivity(status.agent_activity);
            }
            
            // Display agent logs for current step only (real-time step-by-step display)
            if (status.agent_logs && status.agent_logs.length > 0) {
                displayStepBasedAgentLogs(status.agent_logs, status.step);
            }
            
            // Display AGV logs if available (separate from analysis logs)
            if (status.agv_logs && status.agv_logs.length > 0) {
                displayAgentLogs(status.agv_logs);
            }
            
            // Update status message based on current state
            switch(status.status) {
                case 'analyzing':
                    updateStatus('ü§ñ AI agents analyzing request...', 'info');
                    break;
                case 'awaiting_approval':
                    updateStatus('‚úÖ Analysis complete. Awaiting supervisor approval.', 'warning');
                    // Show approval section if results are available and not already processed
                    if (status.results && !approvalProcessed) {
                        displayAnalysisResults(status.results);
                    }
                    break;
                case 'agv_dispatch_phase1':
                    updateStatus('üöÄ AGV Dispatch - Phase 1: Preparing AGV for dispatch...', 'info');
                    updateProgress('AGV Dispatch - Phase 1', 0);
                    break;
                case 'agv_dispatch_phase2':
                    updateStatus('ü§ñ AGV Dispatch - Phase 2: AGV navigating to pickup point...', 'info');
                    updateProgress('AGV Dispatch - Phase 2', 30);
                    break;
                case 'material_pickup_phase1':
                    updateStatus('üì¶ Material Pickup - Phase 1: Loading materials...', 'info');
                    updateProgress('Material Pickup - Phase 1', 50);
                    break;
                case 'material_pickup_phase2':
                    updateStatus('‚úÖ Material Pickup - Phase 2: Securing materials...', 'info');
                    updateProgress('Material Pickup - Phase 2', 80);
                    break;
                case 'delivery':
                    updateStatus('üéØ Final Delivery: AGV delivering to destination...', 'info');
                    updateProgress('Delivery in Progress', 95);
                    break;
                case 'completed':
                    updateStatus('‚úÖ Workflow completed successfully!', 'success');
                    showCompletion(status);
                    stopRealTimeUpdates();
                    break;
                case 'rejected':
                    updateStatus('‚ùå Request rejected', 'error');
                    stopRealTimeUpdates();
                    resetForm();
                    break;
                case 'error':
                    updateStatus('‚ùå Workflow error occurred', 'error');
                    stopRealTimeUpdates();
                    break;
            }
        }
        
        function updateStepProgress(status) {
            // Reset all steps
            for (let i = 1; i <= 7; i++) {
                const stepEl = document.getElementById('step' + i);
                stepEl.className = 'step waiting';
            }
            
            // Update based on current step
            if (status.step >= 1) {
                for (let i = 1; i < status.step; i++) {
                    document.getElementById('step' + i).className = 'step completed';
                }
                if (status.step <= 7) {
                    document.getElementById('step' + status.step).className = 'step active';
                }
            }
            
            // Special handling for analysis phase
            if (status.status === 'awaiting_approval') {
                for (let i = 1; i <= 4; i++) {
                    document.getElementById('step' + i).className = 'step completed';
                }
            }
            
            // Special handling for completion
            if (status.status === 'completed') {
                for (let i = 1; i <= 7; i++) {
                    document.getElementById('step' + i).className = 'step completed';
                }
            }
        }
        
        function updateStatus(message, type) {
            const statusEl = document.getElementById('statusDisplay');
            statusEl.textContent = message;
            statusEl.className = 'status-display status-' + type;
        }
        
        function updateProgress(label, percent) {
            document.getElementById('progressLabel').textContent = label;
            document.getElementById('progressBar').style.width = percent + '%';
        }
        
        function displayAnalysisResults(results) {
            // Extract LLM responses from orchestrator result
            const orchestratorResult = results.orchestrator_result || "Analysis completed";
            
            // Display agent responses (the actual LLM outputs)
            document.getElementById('inventoryResponse').innerHTML = `
                <div style="background: #f8f9fa; padding: 1rem; border-radius: 0.5rem; border-left: 4px solid #10b981;">
                    <p><strong>üì¶ Available:</strong> ${results.inventory.available_quantity} units</p>
                    <p><strong>üè≠ Location:</strong> ${results.inventory.warehouse_location}</p>
                    <p><strong>üìä Status:</strong> ${results.inventory.stock_status}</p>
                    ${results.inventory.ai_assessment ? `<p style="margin-top: 0.5rem; color: #6b7280;"><em>"${results.inventory.ai_assessment}"</em></p>` : ''}
                </div>
            `;
            
            document.getElementById('fleetResponse').innerHTML = `
                <div style="background: #f8f9fa; padding: 1rem; border-radius: 0.5rem; border-left: 4px solid #f59e0b;">
                    <p><strong>ü§ñ AGV:</strong> ${results.fleet.vehicle_id}</p>
                    <p><strong>üîã Battery:</strong> ${results.fleet.battery_level}%</p>
                    <p><strong>üìç Status:</strong> ${results.fleet.availability_status}</p>
                </div>
            `;
            
            const estimatedCost = results.approval.estimated_cost || 270.0;
            document.getElementById('approvalResponse').innerHTML = `
                <div style="background: #f8f9fa; padding: 1rem; border-radius: 0.5rem; border-left: 4px solid #8b5cf6;">
                    <p><strong>üí∞ Total Cost:</strong> $${estimatedCost.toFixed(2)}</p>
                    <p><strong>üìã Status:</strong> ${results.approval.status}</p>
                    <p><strong>‚öñÔ∏è Recommendation:</strong> ${estimatedCost > 500 ? 'Requires approval due to high cost' : 'Approved for processing'}</p>
                </div>
            `;
            
            document.getElementById('orchestratorResponse').innerHTML = `
                <div style="background: #f8f9fa; padding: 1rem; border-radius: 0.5rem; border-left: 4px solid #ef4444;">
                    <p style="color: #374151; line-height: 1.5;">${orchestratorResult.substring(0, 300)}${orchestratorResult.length > 300 ? '...' : ''}</p>
                </div>
            `;
            
            document.getElementById('analysisResults').classList.remove('hidden');
            
            // Store results for approval functions
            window.lastResults = results;
            window.lastCost = estimatedCost;
            
            // Only show approval section if cost is high (>$500)
            if (estimatedCost > 500) {
                const approvalSection = document.getElementById('approvalSection');
                const approvalSummary = document.getElementById('approvalSummary');
                
                approvalSection.classList.remove('hidden');
                approvalSummary.innerHTML = `
                    <strong>High Cost Alert:</strong> This request costs $${estimatedCost.toFixed(2)}, which exceeds the $500 threshold.
                    <br><span style="font-size: 0.9rem; opacity: 0.9;">Supervisor approval is required before proceeding.</span>
                `;
            } else {
                // Low cost - auto approve and show completion
                updateStatus('‚úÖ Request approved and processed successfully!', 'success');
                showCompletionWithSummary(results, estimatedCost);
            }
        }
        
        function showCompletionWithSummary(results, cost) {
            document.getElementById('completionSection').classList.remove('hidden');
            document.getElementById('finalSummary').innerHTML = `
                <p><strong>üì¶ Part:</strong> ${results.inventory ? 'Ready for delivery' : 'Processing'}</p>
                <p><strong>üöõ AGV:</strong> ${results.fleet?.vehicle_id || 'Assigned'}</p>
                <p><strong>üí∞ Total Cost:</strong> $${cost.toFixed(2)}</p>
                <p><strong>‚è±Ô∏è Processing Time:</strong> ${workflowStartTime ? ((Date.now() - workflowStartTime) / 1000).toFixed(1) + 's' : 'Completed'}</p>
                <div style="margin-top: 1rem; padding: 1rem; background: rgba(16, 185, 129, 0.1); border-radius: 0.5rem;">
                    <p style="color: #065f46; margin: 0;">Request has been processed successfully and is ready for fulfillment.</p>
                </div>
            `;
            
            // Enable form for new requests
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = false;
            submitBtn.textContent = 'üöÄ Submit New Request';
        }


        
        // Simplified global variables
        let workflowStartTime = null;
        
        // Enhanced function for step-based agent message display with modern styling
        function displayStepBasedAgentLogs(logs, currentStep) {
            const agentLogsContainer = document.getElementById('agentLogs');
            
            // Hide "no activity" message when we have logs
            if (logs && logs.length > 0) {
                const noActivity = agentLogsContainer.querySelector('.no-activity');
                if (noActivity) {
                    noActivity.remove();
                }
            }
            
            // Only show messages for current step and completed steps
            const visibleLogs = logs.filter(log => {
                // If debug mode is enabled, show all logs regardless of step
                if (window._debug_show_all_logs) return true;
                // Show all logs for steps that are completed (step < currentStep)
                // or show logs for the current active step
                return log.step <= currentStep || currentStep === 0; // 0 means ready for approval, show all
            });
            
            // Only add new logs that haven't been displayed yet
            if (visibleLogs && visibleLogs.length > displayedStepLogsCount) {
                const newLogs = visibleLogs.slice(displayedStepLogsCount);
                
                newLogs.forEach((log, index) => {
                    const logDiv = document.createElement('div');
                    
                    // Add agent-specific CSS classes
                    const agentClass = log.agent.toLowerCase().replace(/\s+/g, '-');
                    logDiv.className = `agent-log ${agentClass}`;
                    
                    logDiv.innerHTML = `
                        <div class="agent-header">
                            <span class="agent-name ${agentClass}">${log.agent}</span>
                            <span class="agent-timestamp">${log.timestamp}</span>
                        </div>
                        <div class="agent-message">${log.message}</div>
                    `;
                    
                    // Add smooth entrance animation with staggered delay
                    logDiv.style.opacity = '0';
                    logDiv.style.transform = 'translateX(20px)';
                    agentLogsContainer.appendChild(logDiv);
                    
                    // Trigger animation with delay for each message
                    setTimeout(() => {
                        logDiv.style.transition = 'all 0.2s ease-out';
                        logDiv.style.opacity = '1';
                        logDiv.style.transform = 'translateX(0)';
                        
                        // Sync step progress with each message (with slight delay)
                        setTimeout(() => {
                            syncStepWithAgentMessage(log);
                        }, 100);
                        
                    }, 10 + (index * 150)); // Staggered animation
                    
                    // Update message counter
                    totalMessageCount++;
                    updateMessageCounter();
                });
                
                displayedStepLogsCount = visibleLogs.length;
                
                // Smooth auto-scroll to bottom after all animations
                setTimeout(() => {
                    agentLogsContainer.scrollTo({
                        top: agentLogsContainer.scrollHeight,
                        behavior: 'smooth'
                    });
                }, 100 + (newLogs.length * 150));
            }
        }
        
        function displayAgentLogs(logs) {
            const agentLogsContainer = document.getElementById('agentLogs');
            
            // Hide "no activity" message when we have logs
            if (logs && logs.length > 0) {
                // Remove "no activity" message only once
                const noActivity = agentLogsContainer.querySelector('.no-activity');
                if (noActivity) {
                    noActivity.remove();
                }
            }
            
            // Only add new logs that haven't been displayed yet (for AGV logs)
            if (logs && logs.length > displayedLogsCount) {
                const newLogs = logs.slice(displayedLogsCount);
                
                newLogs.forEach(log => {
                    const logDiv = document.createElement('div');
                    
                    // Add agent-specific CSS classes
                    const agentClass = log.agent.toLowerCase().replace(/\s+/g, '-');
                    logDiv.className = `agent-log ${agentClass}`;
                    
                    logDiv.innerHTML = `
                        <div class="agent-header">
                            <span class="agent-name ${agentClass}">${log.agent}</span>
                            <span class="agent-timestamp">${log.timestamp}</span>
                        </div>
                        <div class="agent-message">${log.message}</div>
                    `;
                    
                    // Add smooth entrance animation
                    logDiv.style.opacity = '0';
                    logDiv.style.transform = 'translateX(20px)';
                    agentLogsContainer.appendChild(logDiv);
                    
                    // Trigger animation
                    setTimeout(() => {
                        logDiv.style.transition = 'all 0.2s ease-out';
                        logDiv.style.opacity = '1';
                        logDiv.style.transform = 'translateX(0)';
                    }, 10);
                    
                    // Update message counter
                    totalMessageCount++;
                    updateMessageCounter();
                });
                
                displayedLogsCount = logs.length;
                
                // Smooth auto-scroll to bottom
                setTimeout(() => {
                    agentLogsContainer.scrollTo({
                        top: agentLogsContainer.scrollHeight,
                        behavior: 'smooth'
                    });
                }, 100);
            }
        }
        
        function updateAgentActivity(activity) {
            const activityDiv = document.getElementById('currentActivity');
            if (activity) {
                activityDiv.textContent = activity;
                activityDiv.style.display = 'block';
            } else {
                activityDiv.style.display = 'none';
            }
        }
        
        function showCompletion(status) {
            const totalTime = workflowStartTime ? 
                ((Date.now() - workflowStartTime) / 1000).toFixed(1) + 's' : '--';
            
            document.getElementById('totalTime').textContent = totalTime;
            document.getElementById('agvUsed').textContent = status.results?.fleet?.vehicle_id || 'AGV-001';
            document.getElementById('finalCost').textContent = '$' + (status.results?.total_cost?.toFixed(2) || '--');
            
            // Hide progress section and show completion, but keep everything else visible
            document.getElementById('progressSection').classList.add('hidden');
            document.getElementById('completionSection').classList.remove('hidden');
            
            // Make sure analysis results and agent logs remain visible
            document.getElementById('analysisResults').classList.remove('hidden');
            
            // Enable form for new requests but keep all messages visible
            document.getElementById('submitBtn').disabled = false;
            
            // Add visual indicator that form is ready for new request
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.textContent = 'üöÄ Start New Workflow';
            submitBtn.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
            
            // Update current activity to show completion
            updateAgentActivity('‚úÖ All operations completed successfully - Ready for new request');
        }
        
        function updateMessageCounter() {
            const counter = document.getElementById('messageCounter');
            if (totalMessageCount === 0) {
                counter.textContent = 'Ready for agent communications';
            } else {
                counter.textContent = `${totalMessageCount} messages ‚Ä¢ Live feed active`;
            }
        }
        
        function clearPreviousResults() {
            // Clear workflow sections
            document.getElementById('workflowSection').classList.add('hidden');
            document.getElementById('analysisResults').classList.add('hidden');
            document.getElementById('approvalSection').classList.add('hidden');
            document.getElementById('completionSection').classList.add('hidden');
            
            workflowStartTime = null;
        }
        
        function resetForm() {
            // Full reset including showing welcome section (used for errors/rejections)
            clearPreviousResults();
            document.getElementById('submitBtn').disabled = false;
            document.getElementById('welcomeSection').classList.remove('hidden');
            
            // Reset button text and style
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.textContent = 'üöÄ Start Workflow';
            submitBtn.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
        }
        
        // Real Strands Observability Functions
        async function fetchRealObservabilityData() {
            /* Fetch real observability data from Strands framework */
            try {
                const response = await fetch('/api/agent_messages');
                const data = await response.json();
                
                if (data.status === 'success') {
                    console.log(`üîç Real observability: ${data.real_observability_count} real messages, ${data.legacy_message_count} legacy messages`);
                    return data.agent_logs;
                }
                return [];
            } catch (error) {
                console.error('Error fetching real observability data:', error);
                return [];
            }
        }
        
        async function fetchToolCallDetails() {
            /* Fetch detailed tool call information */
            try {
                const response = await fetch('/api/observability/tool_calls');
                const data = await response.json();
                
                if (data.status === 'success') {
                    console.log(`üõ†Ô∏è Tool calls captured: ${data.total_calls}`);
                    return data.tool_calls;
                }
                return [];
            } catch (error) {
                console.error('Error fetching tool calls:', error);
                return [];
            }
        }
        
        async function fetchAgentCommunications() {
            /* Fetch agent-to-agent communications */
            try {
                const response = await fetch('/api/observability/agent_communications');
                const data = await response.json();
                
                if (data.status === 'success') {
                    console.log(`ü§ñ Agent communications: ${data.total_communications}`);
                    return data.communications;
                }
                return [];
            } catch (error) {
                console.error('Error fetching agent communications:', error);
                return [];
            }
        }
        
        function displayRealObservabilityMessage(message) {
            /* Display a real observability message with enhanced UI */
            const agentLogsContainer = document.getElementById('agentLogs');
            
            const logDiv = document.createElement('div');
            const agentClass = message.agent.toLowerCase().replace(/\s+/g, '-');
            
            // Add special styling for real observability messages
            logDiv.className = `agent-log ${agentClass} real-observability`;
            
            // Enhanced display with observability metadata
            let metadataDisplay = '';
            if (message.metadata && Object.keys(message.metadata).length > 0) {
                metadataDisplay = `
                    <div class="observability-metadata">
                        <small>Metadata: ${JSON.stringify(message.metadata, null, 1)}</small>
                    </div>
                `;
            }
            
            logDiv.innerHTML = `
                <div class="agent-header">
                    <span class="agent-name ${agentClass}">
                        üîç ${message.agent}
                        ${message.type === 'tool_call' ? 'üõ†Ô∏è' : ''}
                        ${message.type === 'progress' ? 'üìä' : ''}
                        ${message.type === 'agent_communication' ? 'ü§ñ' : ''}
                    </span>
                    <span class="agent-timestamp">${message.timestamp}</span>
                </div>
                <div class="agent-message">${message.message}</div>
                ${metadataDisplay}
                ${message.progress !== undefined ? `<div class="progress-bar" style="width: ${message.progress * 100}%"></div>` : ''}
            `;
            
            // Add special styling for real observability
            logDiv.style.borderLeft = '4px solid #10b981';
            logDiv.style.backgroundColor = 'rgba(16, 185, 129, 0.05)';
            
            // Animation
            logDiv.style.opacity = '0';
            logDiv.style.transform = 'translateX(20px)';
            agentLogsContainer.appendChild(logDiv);
            
            setTimeout(() => {
                logDiv.style.transition = 'all 0.3s ease-out';
                logDiv.style.opacity = '1';
                logDiv.style.transform = 'translateX(0)';
            }, 10);
            
            // Auto-scroll
            setTimeout(() => {
                agentLogsContainer.scrollTo({
                    top: agentLogsContainer.scrollHeight,
                    behavior: 'smooth'
                });
            }, 100);
        }
        
        // Enhanced status monitoring with real observability
        async function monitorWorkflowStatusWithObservability() {
            /* Enhanced workflow monitoring with real observability data */
            const status = await updateWorkflowDisplay();
            
            // Fetch real observability data during active workflow
            if (status && status.active) {
                const realMessages = await fetchRealObservabilityData();
                const toolCalls = await fetchToolCallDetails();
                const communications = await fetchAgentCommunications();
                
                console.log('üìä Real Observability Summary:', {
                    messages: realMessages.length,
                    toolCalls: toolCalls.length,
                    communications: communications.length
                });
            }
            
            return status;
        }
        
        // Load form options from configuration
        async function loadFormOptions() {
            console.log('Starting loadFormOptions...');
            try {
                console.log('Fetching from /api/form_data...');
                const response = await fetch('/api/form_data');
                console.log('Response received:', response.status, response.statusText);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                console.log('Parsed JSON result:', result);
                
                if (result.success && result.data) {
                    const data = result.data;
                    console.log('Success! Calling populateFormDropdowns...');
                    populateFormDropdowns(data);
                    console.log('Loaded form options from API:', {
                        parts: data.parts.length,
                        destinations: data.destinations.length,
                        priorities: data.priorities.length
                    });
                    return true; // Success
                } else {
                    throw new Error(result.error || 'API returned success=false');
                }
            } catch (error) {
                console.error('Error loading form options from API:', error);
                console.log('API failed, keeping fallback options...');
                return false; // Failed
            }
        }
        
        function populateFormDropdowns(data) {
            console.log('populateFormDropdowns called with data:', data);
            
            // Populate parts dropdown
            console.log('Populating parts dropdown...');
            const partSelect = document.getElementById('partNumber');
            if (!partSelect) {
                console.error('partNumber element not found!');
                return;
            }
            
            partSelect.innerHTML = '';
            if (data.parts && data.parts.length > 0) {
                data.parts.forEach((part, index) => {
                    console.log(`Adding part ${index + 1}:`, part);
                    const option = document.createElement('option');
                    option.value = part.value;
                    option.textContent = part.label;
                    partSelect.appendChild(option);
                });
                // Select first part by default
                partSelect.value = data.parts[0].value;
                console.log('Parts dropdown populated with', data.parts.length, 'parts');
            } else {
                console.warn('No parts data available');
            }
            
            // Populate destinations dropdown
            const destSelect = document.getElementById('destination');
            destSelect.innerHTML = '';
            data.destinations.forEach(dest => {
                const option = document.createElement('option');
                option.value = dest.value;
                option.textContent = dest.label;
                destSelect.appendChild(option);
            });
            // Select first destination by default
            if (data.destinations.length > 0) {
                destSelect.value = data.destinations[0].value;
            }
            
            // Populate priorities dropdown
            const prioritySelect = document.getElementById('priority');
            prioritySelect.innerHTML = '';
            data.priorities.forEach(priority => {
                const option = document.createElement('option');
                option.value = priority.value;
                option.textContent = priority.label;
                prioritySelect.appendChild(option);
            });
            // Select "MEDIUM" priority by default
            prioritySelect.value = 'MEDIUM';
            
            console.log('All dropdowns populated successfully!');
            console.log('Final dropdown states:', {
                partOptions: partSelect.options.length,
                destOptions: destSelect.options.length,
                priorityOptions: prioritySelect.options.length
            });
        }
        
        function loadFallbackOptions() {
            // Fallback data when API is not available
            console.log('Loading fallback form options...');
            
            const fallbackData = {
                parts: [
                    { value: "HYDRAULIC-PUMP-HP450", label: "HYDRAULIC-PUMP-HP450 - Heavy-duty hydraulic pump for CNC machinery" },
                    { value: "PART-ABC123", label: "PART-ABC123 - Standard production part" },
                    { value: "PART-XYZ789", label: "PART-XYZ789 - Specialized part" },
                    { value: "PART-DEF456", label: "PART-DEF456 - Common component" }
                ],
                destinations: [
                    { value: "Production Line A", label: "Production Line A - Main assembly line" },
                    { value: "Production Line B", label: "Production Line B - Secondary production" },
                    { value: "Central Warehouse", label: "Central Warehouse - Primary storage facility" },
                    { value: "Quality Control", label: "Quality Control - Inspection station" }
                ],
                priorities: [
                    { value: "LOW", label: "Low Priority" },
                    { value: "MEDIUM", label: "Medium Priority" },
                    { value: "HIGH", label: "High Priority" },
                    { value: "URGENT", label: "Urgent Priority" }
                ]
            };
            
            populateFormDropdowns(fallbackData);
            console.log('Fallback form options loaded successfully');
        }
        
        // Add a backup mechanism to ensure dropdowns are always populated
        function ensureDropdownsPopulated() {
            // Check if dropdowns are still showing "Loading..." after 3 seconds
            setTimeout(() => {
                const partSelect = document.getElementById('partNumber');
                if (partSelect && partSelect.innerHTML.includes('Loading parts')) {
                    console.warn('‚ö†Ô∏è Dropdowns still loading after 3 seconds, forcing fallback...');
                    loadFallbackOptions();
                }
            }, 3000);
        }

        // Start real observability monitoring on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Real Strands Observability UI Ready');
            console.log('DOM Content Loaded - Starting initialization...');
            
            // Load form options from configuration
            console.log('About to call loadFormOptions...');
            
            // Load fallback options first to ensure dropdowns are always selectable
            console.log('Loading fallback options immediately...');
            loadFallbackOptions();
            
            // Add debugging to show dropdown states
            setTimeout(() => {
                const partSelect = document.getElementById('partNumber');
                const destSelect = document.getElementById('destination');
                const prioritySelect = document.getElementById('priority');
                
                console.log('DROPDOWN DEBUG:', {
                    partOptions: partSelect ? partSelect.options.length : 'NOT FOUND',
                    destOptions: destSelect ? destSelect.options.length : 'NOT FOUND',
                    priorityOptions: prioritySelect ? prioritySelect.options.length : 'NOT FOUND',
                    partHTML: partSelect ? partSelect.innerHTML.substring(0, 100) : 'NOT FOUND',
                    destHTML: destSelect ? destSelect.innerHTML.substring(0, 100) : 'NOT FOUND',
                    priorityHTML: prioritySelect ? prioritySelect.innerHTML.substring(0, 100) : 'NOT FOUND'
                });
            }, 1000);
            
            // Then try to load from API (will override fallback if successful)
            setTimeout(() => {
                console.log('üì° Attempting to load from API...');
                loadFormOptions();
            }, 500);
            
            // Set up backup mechanism in case everything fails
            setTimeout(() => {
                const partSelect = document.getElementById('partNumber');
                if (partSelect && (partSelect.options.length <= 1 || partSelect.innerHTML.includes('Loading'))) {
                    console.warn('‚ö†Ô∏è Dropdowns still not populated after 2 seconds, forcing fallback again...');
                    loadFallbackOptions();
                }
            }, 2000);
            // If URL contains ?debug_sse=1 enable debug mode to show all logs and extra diagnostics
            try {
                const params = new URLSearchParams(window.location.search);
                if (params.get('debug_sse') === '1') {
                    window._debug_show_all_logs = true;
                    console.warn('üõ†Ô∏è DEBUG MODE: debug_sse=1 ‚Äî showing all step logs and extra SSE diagnostics');
                }
            } catch (e) {
                // ignore
            }
            
            // Test function for LLM display
            window.testLLMDisplay = function() {
                const llmArea = document.getElementById('llmResponse');
                if (llmArea) {
                    const testContent = `Test LLM Response Display

To analyze the logistics request, we will break it down into several steps:

1. Inventory check:
{"name": "inventory_agent_tool", "parameters": {"query": "Check availability for part HYDRAULIC-PUMP-HP450, quantity 15"}}

2. Fleet coordination:
{"name": "fleet_agent_tool", "parameters": {"query": "Schedule delivery from Warehouse A to Production Line A"}}

3. Approval request:
{"name": "approval_agent_tool", "parameters": {"query": "Review and approve request for 15 units"}}

This is a comprehensive analysis with detailed recommendations.`;
                    
                    llmArea.innerHTML = `<strong>ü§ñ AI Analysis & Recommendations:</strong><br><br>${testContent.replace(/\n/g, '<br>')}`;
                    llmArea.style.border = '2px solid #10b981';
                    console.log('‚úÖ Test LLM display updated');
                }
            };
            
            // Add CSS for real observability messages
            const style = document.createElement('style');
            style.textContent = `
                .real-observability {
                    animation: realObservabilityPulse 0.5s ease-in-out;
                }
                
                @keyframes realObservabilityPulse {
                    0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4); }
                    50% { box-shadow: 0 0 10px 5px rgba(16, 185, 129, 0.1); }
                    100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
                }
                
                .observability-metadata {
                    background: rgba(0, 0, 0, 0.05);
                    padding: 4px 8px;
                    border-radius: 4px;
                    margin-top: 4px;
                    font-family: monospace;
                    font-size: 0.8em;
                }
                
                .progress-bar {
                    height: 2px;
                    background: linear-gradient(90deg, #10b981, #059669);
                    margin-top: 4px;
                    border-radius: 1px;
                    transition: width 0.3s ease;
                }
            `;
            document.head.appendChild(style);
            
            // Approval functions
            window.showApprovalPanel = function(data) {
                const panel = document.getElementById('approvalPanel');
                const details = document.getElementById('approvalDetails');
                
                if (panel && details) {
                    details.innerHTML = `<strong>Cost: ${data.content.match(/\$[\d,]+/)?.[0] || 'High'}</strong><br>${data.content}`;
                    panel.style.display = 'block';
                    console.log('üîî Showing approval panel for:', data);
                }
            };
            
            window.handleApproval = function(decision) {
                const reason = document.getElementById('approvalReason').value || '';
                const panel = document.getElementById('approvalPanel');
                
                console.log(`üìã Handling approval: ${decision}, reason: ${reason}`);
                
                // Disable buttons to prevent double-click
                document.getElementById('approveBtn').disabled = true;
                document.getElementById('rejectBtn').disabled = true;
                
                // Send approval decision to backend
                fetch('/api/approve', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        decision: decision,
                        reason: reason
                    })
                })
                .then(response => response.json())
                .then(data => {
                    console.log('‚úÖ Approval response:', data);
                    if (data.success) {
                        panel.style.display = 'none';
                        updateStatus(`${decision === 'approve' ? '‚úÖ Request approved' : '‚ùå Request rejected'}: ${reason}`, 
                                   decision === 'approve' ? 'success' : 'error');
                    }
                })
                .catch(error => {
                    console.error('‚ùå Approval error:', error);
                    updateStatus('Error processing approval decision', 'error');
                    
                    // Re-enable buttons on error
                    document.getElementById('approveBtn').disabled = false;
                    document.getElementById('rejectBtn').disabled = false;
                });
            };
        });
    </script>
</body>
</html>